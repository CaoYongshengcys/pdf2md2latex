<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF转Markdown转LaTeX工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background-color: #f8f9fa;
            border-color: #0056b3;
        }
        .upload-area.dragover {
            background-color: #e7f3ff;
            border-color: #0056b3;
        }
        .content-display {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .markdown-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .latex-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .alert {
            display: none;
            margin: 15px 0;
        }
        .btn-group-custom {
            margin: 10px 0;
        }
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        .log-display {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .log-container {
            display: none;
            margin: 20px 0;
        }
        .log-header {
            background-color: #343a40;
            color: white;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .log-filter {
            background-color: #495057;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .log-search {
            background-color: #495057;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            width: 150px;
        }
        .log-search::placeholder {
            color: #adb5bd;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #343a40;
        }
        .log-timestamp {
            color: #6c757d;
            margin-right: 8px;
        }
        .log-level-info {
            color: #17a2b8;
        }
        .log-level-success {
            color: #28a745;
        }
        .log-level-warning {
            color: #ffc107;
        }
        .log-level-error {
            color: #dc3545;
        }
        .log-level-debug {
            color: #6f42c1;
        }
        .log-stats {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 10px 15px;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="text-center mb-4">PDF转Markdown转LaTeX工具</h1>
                <p class="text-center text-muted">将PDF文件转换为Markdown，然后转换为LaTeX格式</p>
            </div>
        </div>

        <!-- 上传区域 -->
        <div class="row">
            <div class="col-lg-12">
                <div class="upload-area" id="uploadArea">
                    <div class="mb-3">
                        <svg class="bi bi-file-earmark-pdf" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.266.266 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.71 12.71 0 0 1 1.01-.193 11.744 11.744 0 0 1-.51-.858 20.801 20.801 0 0 1-.5 1.05zm2.446.45c.15.163.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.876 3.876 0 0 0-.612-.053zM8.078 7.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
                        </svg>
                    </div>
                    <h4>拖拽PDF文件到此处或点击选择文件</h4>
                    <p class="text-muted">支持PDF格式，最大16MB</p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        选择PDF文件
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在处理文件，请稍候...</p>
        </div>

        <!-- 提示信息 -->
        <div class="alert alert-danger" id="errorAlert" role="alert"></div>
        <div class="alert alert-success" id="successAlert" role="alert"></div>

        <!-- 日志显示区域 -->
        <div class="log-container" id="logContainer">
            <div class="log-header">
                <span>转换日志</span>
                <div class="log-controls">
                    <select class="log-filter" id="logFilter" onchange="filterLogs()">
                        <option value="all">全部</option>
                        <option value="info">信息</option>
                        <option value="success">成功</option>
                        <option value="warning">警告</option>
                        <option value="error">错误</option>
                        <option value="debug">调试</option>
                    </select>
                    <input type="text" class="log-search" id="logSearch" placeholder="搜索日志..." oninput="searchLogs()">
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="clearLogs()">清空</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="exportLogs()">导出</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleAutoRefresh()" id="autoRefreshBtn">自动刷新: 开</button>
                    <button type="button" class="btn-close btn-close-white" onclick="closeLogContainer()"></button>
                </div>
            </div>
            <div class="log-body">
                <div class="log-display" id="logDisplay"></div>
            </div>
            <div class="log-stats" id="logStats">
                <span>总日志数: <span id="totalLogs">0</span></span>
                <span>信息: <span id="infoLogs">0</span> | 成功: <span id="successLogs">0</span> | 警告: <span id="warningLogs">0</span> | 错误: <span id="errorLogs">0</span> | 调试: <span id="debugLogs">0</span></span>
            </div>
        </div>

        <!-- 内容显示区域 -->
        <div class="row" id="contentArea" style="display: none;">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Markdown内容</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('md')">
                                复制
                            </button>
                            <button class="btn btn-outline-primary" onclick="downloadMarkdown()">
                                下载MD
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="content-display" id="markdownContent"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">LaTeX内容</h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('latex')">
                                复制
                            </button>
                            <button class="btn btn-outline-success" onclick="downloadLatex()">
                                下载TEX
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="content-display" id="latexContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 大模型优化选项 -->
        <div class="row" id="optimizationOptions" style="display: none;">
            <div class="col-lg-12">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">大模型优化选项</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="optimizeWithLLM">
                                    <label class="form-check-label" for="optimizeWithLLM">
                                        使用大模型优化Markdown内容
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="modelSelect" disabled>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="input-group">
                                    <span class="input-group-text">API密钥</span>
                                    <input type="password" class="form-control" id="apiKeyInput" 
                                           placeholder="输入OpenAI API密钥" disabled>
                                    <button class="btn btn-outline-secondary" type="button" id="optimizeOnlyBtn" disabled>
                                        仅优化内容
                                    </button>
                                </div>
                                <div class="form-text text-muted">
                                    启用优化后，大模型将改善文档结构、修正语法错误、优化数学公式格式
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 转换按钮 -->
        <div class="row" id="convertButton" style="display: none;">
            <div class="col-lg-12 text-center">
                <div class="btn-group" role="group">
                    <button class="btn btn-success btn-lg" onclick="convertToLatex()">
                        转换为LaTeX
                    </button>
                    <button class="btn btn-info btn-lg" onclick="optimizeAndConvert()" id="optimizeAndConvertBtn" disabled>
                        优化并转换
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-latex.min.js"></script>
    <script>
        let currentFilename = '';
        let currentMdContent = '';
        let currentLatexContent = '';
        let logEntries = [];
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = true;

        // 文件上传处理
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const contentArea = document.getElementById('contentArea');
        const convertButton = document.getElementById('convertButton');
        const optimizationOptions = document.getElementById('optimizationOptions');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        
        // 大模型优化相关元素
        const optimizeWithLLM = document.getElementById('optimizeWithLLM');
        const modelSelect = document.getElementById('modelSelect');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const optimizeOnlyBtn = document.getElementById('optimizeOnlyBtn');
        const optimizeAndConvertBtn = document.getElementById('optimizeAndConvertBtn');
        
        // 大模型优化选项事件监听
        optimizeWithLLM.addEventListener('change', function() {
            const isEnabled = this.checked;
            modelSelect.disabled = !isEnabled;
            apiKeyInput.disabled = !isEnabled;
            optimizeOnlyBtn.disabled = !isEnabled;
            optimizeAndConvertBtn.disabled = !isEnabled;
            
            if (isEnabled && !apiKeyInput.value.trim()) {
                apiKeyInput.focus();
            }
        });
        
        // 仅优化内容按钮
        optimizeOnlyBtn.addEventListener('click', function() {
            if (!currentMdContent) {
                showError('没有可优化的Markdown内容');
                return;
            }
            
            if (!apiKeyInput.value.trim()) {
                showError('请输入API密钥');
                return;
            }
            
            optimizeMarkdown();
        });

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // 文件选择
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('请选择PDF文件');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('文件大小不能超过16MB');
                return;
            }

            uploadFile(file);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            hideAlerts();
            showLogContainer();
            clearLogDisplay();
            addLogMessage('开始上传文件: ' + file.name);

            // 使用普通的fetch请求处理文件上传
            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    currentFilename = data.filename;
                    currentMdContent = data.md_content;
                    displayMarkdown(data.md_content);
                    showSuccess('PDF转换成功！');
                    contentArea.style.display = 'none';
                    convertButton.style.display = 'block';
                    optimizationOptions.style.display = 'block';
                    addLogMessage('PDF转换完成，已生成Markdown内容', 'success');
                } else {
                    showError(data.error || '转换失败');
                    addLogMessage('转换失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showError('上传失败：' + error.message);
                addLogMessage('上传失败: ' + error.message, 'error');
            });
        }

        function optimizeMarkdown() {
            if (!currentMdContent) {
                showError('没有可优化的Markdown内容');
                return;
            }

            showLoading(true);
            hideAlerts();

            fetch('/optimize_md', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    md_content: currentMdContent,
                    llm_api_key: apiKeyInput.value.trim(),
                    model: modelSelect.value
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    currentMdContent = data.optimized_content;
                    displayMarkdown(data.optimized_content);
                    showSuccess(`Markdown优化成功！原长度: ${data.original_length}, 优化后长度: ${data.optimized_length}`);
                } else {
                    showError(data.error || '优化失败');
                }
            })
            .catch(error => {
                showLoading(false);
                showError('优化失败：' + error.message);
            });
        }

        function optimizeAndConvert() {
            if (!currentMdContent) {
                showError('没有可转换的Markdown内容');
                return;
            }

            if (!apiKeyInput.value.trim()) {
                showError('请输入API密钥');
                return;
            }

            showLoading(true);
            hideAlerts();

            fetch('/convert_to_latex', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    md_content: currentMdContent,
                    filename: currentFilename,
                    optimize_with_llm: true,
                    llm_api_key: apiKeyInput.value.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    currentLatexContent = data.latex_content;
                    displayLatex(data.latex_content);
                    showSuccess('优化并转换成功！');
                    contentArea.style.display = 'flex';
                    convertButton.style.display = 'none';
                } else {
                    showError(data.error || '转换失败');
                }
            })
            .catch(error => {
                showLoading(false);
                showError('转换失败：' + error.message);
            });
        }

        function convertToLatex() {
            if (!currentMdContent) {
                showError('没有可转换的Markdown内容');
                return;
            }

            showLoading(true);
            hideAlerts();

            const requestData = {
                md_content: currentMdContent,
                filename: currentFilename
            };
            
            // 如果启用了大模型优化，添加相关参数
            if (optimizeWithLLM.checked && apiKeyInput.value.trim()) {
                requestData.optimize_with_llm = true;
                requestData.llm_api_key = apiKeyInput.value.trim();
            }

            fetch('/convert_to_latex', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    currentLatexContent = data.latex_content;
                    displayLatex(data.latex_content);
                    showSuccess('LaTeX转换成功！');
                    contentArea.style.display = 'flex';
                    convertButton.style.display = 'none';
                } else {
                    showError(data.error || '转换失败');
                }
            })
            .catch(error => {
                showLoading(false);
                showError('转换失败：' + error.message);
            });
        }

        function displayMarkdown(content) {
            const markdownContent = document.getElementById('markdownContent');
            markdownContent.innerHTML = `<pre class="markdown-content"><code class="language-markdown">${escapeHtml(content)}</code></pre>`;
            Prism.highlightAll();
        }

        function displayLatex(content) {
            const latexContent = document.getElementById('latexContent');
            latexContent.innerHTML = `<pre class="latex-content"><code class="language-latex">${escapeHtml(content)}</code></pre>`;
            Prism.highlightAll();
        }

        function copyToClipboard(type) {
            const content = type === 'md' ? currentMdContent : currentLatexContent;
            if (!content) {
                showError('没有可复制的内容');
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                showSuccess('内容已复制到剪贴板');
            }).catch(err => {
                showError('复制失败：' + err.message);
            });
        }

        function downloadMarkdown() {
            if (!currentMdContent) {
                showError('没有可下载的Markdown内容');
                return;
            }

            const blob = new Blob([currentMdContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilename.replace('.pdf', '.md');
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadLatex() {
            if (!currentLatexContent) {
                showError('没有可下载的LaTeX内容');
                return;
            }

            fetch('/download_latex', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latex_content: currentLatexContent,
                    filename: currentFilename.replace('.pdf', '.tex')
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFilename.replace('.pdf', '.tex');
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                showError('下载失败：' + error.message);
            });
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
        }

        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
        }

        function hideAlerts() {
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function showLogContainer() {
            document.getElementById('logContainer').style.display = 'block';
            if (isAutoRefreshEnabled && !autoRefreshInterval) {
                startAutoRefresh();
            }
        }
        
        function closeLogContainer() {
            document.getElementById('logContainer').style.display = 'none';
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function clearLogDisplay() {
            logEntries = [];
            updateLogDisplay();
        }
        
        function clearLogs() {
            if (confirm('确定要清空所有日志吗？')) {
                clearLogDisplay();
                addLogMessage('日志已清空', 'info');
            }
        }
        
        function exportLogs() {
            if (logEntries.length === 0) {
                alert('没有日志可导出');
                return;
            }
            
            const logText = logEntries.map(entry => 
                `[${entry.timestamp}] [${entry.level.toUpperCase()}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversion_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function toggleAutoRefresh() {
            isAutoRefreshEnabled = !isAutoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshEnabled) {
                btn.textContent = '自动刷新: 开';
                btn.className = 'btn btn-sm btn-outline-light';
                startAutoRefresh();
            } else {
                btn.textContent = '自动刷新: 关';
                btn.className = 'btn btn-sm btn-outline-secondary';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                fetch('/get_latest_logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            const existingEntry = logEntries.find(entry => 
                                entry.timestamp === log.timestamp && entry.message === log.message
                            );
                            if (!existingEntry) {
                                addLogEntry(log.timestamp, log.message, log.level || 'info');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('获取最新日志失败:', error);
                });
            }, 2000);
        }
        
        function addLogMessage(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            addLogEntry(timestamp, message, level);
        }
        
        function addLogEntry(timestamp, message, level = 'info') {
            logEntries.push({
                timestamp: timestamp,
                message: message,
                level: level
            });
            
            // 限制日志数量，防止内存溢出
            if (logEntries.length > 1000) {
                logEntries = logEntries.slice(-500);
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logDisplay = document.getElementById('logDisplay');
            const filter = document.getElementById('logFilter').value;
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            
            let filteredEntries = logEntries;
            
            // 应用级别过滤
            if (filter !== 'all') {
                filteredEntries = filteredEntries.filter(entry => entry.level === filter);
            }
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.message.toLowerCase().includes(searchTerm) ||
                    entry.timestamp.toLowerCase().includes(searchTerm)
                );
            }
            
            // 生成HTML
            logDisplay.innerHTML = filteredEntries.map(entry => {
                const levelClass = `log-level-${entry.level}`;
                return `<div class="log-entry">
                    <span class="log-timestamp">[${entry.timestamp}]</span>
                    <span class="${levelClass}">[${entry.level.toUpperCase()}]</span>
                    <span>${escapeHtml(entry.message)}</span>
                </div>`;
            }).join('');
            
            // 滚动到底部
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            // 更新统计信息
            updateLogStats();
        }
        
        function updateLogStats() {
            const stats = {
                total: logEntries.length,
                info: logEntries.filter(e => e.level === 'info').length,
                success: logEntries.filter(e => e.level === 'success').length,
                warning: logEntries.filter(e => e.level === 'warning').length,
                error: logEntries.filter(e => e.level === 'error').length,
                debug: logEntries.filter(e => e.level === 'debug').length
            };
            
            document.getElementById('totalLogs').textContent = stats.total;
            document.getElementById('infoLogs').textContent = stats.info;
            document.getElementById('successLogs').textContent = stats.success;
            document.getElementById('warningLogs').textContent = stats.warning;
            document.getElementById('errorLogs').textContent = stats.error;
            document.getElementById('debugLogs').textContent = stats.debug;
        }
        
        function filterLogs() {
            updateLogDisplay();
        }
        
        function searchLogs() {
            updateLogDisplay();
        }
    </script>
</body>
</html>